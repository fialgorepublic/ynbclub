<%= form_with(model: blog, local: true, multipart: true, id: "blog-form") do |form| %>
    <% if blog.errors.any? %>
        <div id="error_explanation">
          <h2><%= pluralize(blog.errors.count, "error") %> prohibited this blog from being saved:</h2>

          <ul>
            <% blog.errors.full_messages.each do |message| %>
                <li><%= message %></li>
            <% end %>
          </ul>
        </div>
    <% end %>
    <div class="container">
      <div class="ambassdor-box newBlog-style">
        <div class="row">
          <div class="col-md-12">
            <div class="row">
              <div class="col-md-8 col-xs-9">
                <h2><a href="/blogs"><i class="fa fa-angle-left"></i></a><%= blog_page_title %></h2>
              </div>
              <!-- <div class="col-md-4 col-xs-3 text-right pull-right">
                <button class="btn btn-default">Save as draft</button>
            <button data-target="#publishPost" data-toggle="modal" class="btn btn-default">Publish</button>
              </div> -->
            </div>
              <hr>
            <div class="row">
              <div class="col-md-8">
                <!--<div class="image-upload">-->
                <!--<div class="dropzone" id="DropZoneFiddle" name="blog[avatar]">-->
                <!--<br/>-->
                <!--</div>-->
                <!--</div>-->
                <div class="field m-image-frame form-group">
                  <%= image_tag(@blog.avatar.attached? ? @blog.avatar.variant(combine_options: { resize: '100x100^', gravity: 'Center', extent: '100x100^', quality: 95 }) : "placeholder.png", alt: "Add  icon", id: 'blah', size: '100x100') %>
                  <lable for="file_name" id="file-name"><%= file_name @blog %></lable>
                  <div class="field form-group" id="image-upload-button-div">
                    <div class="fileUpload form-control start blog-imgUpload">
                      <%= form.file_field :avatar, :id => 'fileupload', class: "filestyle upload", "data-input" => false %>
                    </div>
                  </div>

                </div>
                <!-- <div class="field form-group">
                  <div class="fileUpload form-control start">
                    <%#= form.file_field :avatar, :class=>'upload', :id => 'fileupload' %>
                  </div>
                </div> -->
<div class="row m-t-20">
<div class="Newblog-category">
              <div class="col-md-12">
                <div class="category-option" type="button" data-toggle="popover" id="tooltip-stlye-category" data-placement="top" data-content="Please Select Category First" title="">

                <%= collection_select(:blog, :category_id, Category.all, :id, :name, {:include_blank => 'Select Category'}, html_options = {:class=>"form-control",  :required => true, title: "Please Select Category First"}) %>
              </div>
            </div>
              <!-- <div class="col-md-4">
                <div class="blog-postCategory" type="button" data-toggle="popover" data-placement="top" data-content="Please Select Promote blog post" title="">
                <%#= form.collection_select :promote_post, ["promote 1", "promote 2", "promote 3"], :to_s, :to_s , {:include_blank => 'Promote blog post'}, html_options = {:class=>"form-control"} %>
                </div>
               </div> -->
              </div>
             </div>

<div class="row m-t-30">
        <div class="col-md-12">
          <div class="blogBox-style">
          <div class="box-shadow-am">
            <div class="form-group">
            <!--   <label>Add Title</label> -->
              <%= form.text_field :title, id: :blog_title, class: 'form-control', placeholder: "Add Title",  :required => true %>
            </div>
            <div class="form-group">
              <label>Enter Text</label>
              <%= form.cktext_area :description, id: :blog_description, class: 'form-control editor', placeholder: "Enter your Text", required: true %>
              <span id="display_count">Total Words: 0</span>
              <span class="float-right">Minimum Reuqired Words: 150</span>
           </div>
          </div>
         </div>


        <!-- <div class="actions">   
        <div class="create-blog-btn">
      <%#= form.submit class: 'btn btn-success' %>
    </div>
</div> -->
  </div>
      </div>
         </div>
            <div class="col-md-4">
                <div class="product-heading"> 
              <h2> Products </h2>          
              </div>
              <div class="product-toolTips">
   <div class="box-shadow-am sm-pd-am m-t-20 assign-Heading" type="button" data-toggle="popover" data-placement="bottom" data-content="Please Select Product" title="">
            <h4><a href="javascript:void(0);" onclick="get_products();" style="text-decoration: none;">+ Assign Product</a></h4>
                </div>
               </div>
              </div> 
            </div>
          </div>
        </div>
      </div>

      <!-- <div class="row m-t-30">
        <div class="col-md-8">
          <div class="box-shadow-am">
            <div class="form-group">
              <label>Add Title</label>
              <%#= form.text_field :title, id: :blog_title, class: 'form-control', placeholder: "Add Title",  :required => true %>
            </div>
            <div class="form-group">
              <label>Enter Text</label>
              <%#= form.text_area :description, id: :blog_description, class: 'form-control editor', placeholder: "Enter your Text" %>

            </div>
          </div>
        </div> -->
        <!--<div class="col-md-4">-->
          <!--<div class="box-shadow-am sm-pd-am">-->
            <!--<h3>Product</h3>-->
            <!--<div class="product-box">-->
              <!--<img width="100%" src="/placeholder.png">-->
            <!--</div>-->
            <!--<div class="product-detail">-->
              <!--<p>Drjort+ INTRAJET FIRMING SOLUTION(1 box/ 5pcs)</p>-->
            <!--</div>-->
            <!--<div class="product-review">-->
              <!--<i class="fa fa-star"></i>-->
              <!--<i class="fa fa-star"></i>-->
              <!--<i class="fa fa-star"></i>-->
              <!--<i class="fa fa-star"></i>-->
            <!--</div>-->
            <!--<div class="product-price">-->
              <!--<h5>250,000</h5>-->
            <!--</div>-->
            <!--<div class="product-offer">-->
              <!--<p>20% we're getting from every purchase</p>-->
            <!--</div>-->
          <!--</div>-->

          <!--  <div class="box-shadow-am sm-pd-am m-t-30">
            <h4><a href="javascript:void(0);" onclick="get_products();" style="text-decoration: none;">+ Assign Product</a></h4>
          </div>
        </div> -->
     <!--  </div> -->
     <div class="create-blog-img">
      <div id="selectedProducts">
        <% if @selected_products.present? %>
            <%= render partial: 'blogs/selected_products' %>
        <% end %>
      </div>
    </div>

     <div class="actions">
    <div class="blog-submt-btn">
      <%= form.submit button_name(form.object), class: 'btn btn-success' %>
    </div> 
  </div>

    </div>

<% end %>


<!-- Modal -->
<div class="modal fade" id="uploadVideo" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body text-center">
        <h4 class="">Add Video from Youtube</h4>
        <div class="form-group">
          <label></label>
          <input type="text" class="form-control" placeholder="Paste Copied">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Save</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
      </div>
    </div>

  </div>
</div>


<!-- Modal -->
<div class="modal fade" id="publishPost" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body text-center">
        <h4 class="">Are you sure you want to unpublish</h4>
        <h5>Blog post name goes here?</h5>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" >yes</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
      </div>
    </div>

  </div>
</div>



<!-- Modal -->
<div class="modal fade" id="assignProduct" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Assign your product to blog post</h4>
      </div>
      <div class="modal-body ">
        <!-- <div class="row">
          <div class="col-md-3">
            <div class="form-group">
              <label>
                Price
              </label>
              <select class="form-control">
                <option>price</option>
              </select>
            </div>
          </div>

          <div class="col-md-3">
            <div class="form-group">
              <label>
                Colors
              </label>
              <select class="form-control">
                <option>Colors</option>
              </select>
            </div>
          </div>

          <div class="col-md-3">
            <div class="form-group">
              <label>
                Size
              </label>
              <select class="form-control">
                <option>Size</option>
              </select>
            </div>
          </div>

          <div class="col-md-3">
            <div class="form-group">
              <label>
                Sorting
              </label>
              <select class="form-control">
                <option>Name Az</option>
              </select>
            </div>
          </div>

        </div> -->

        <div id="products">
          <% if @products.present? %>
              <%= render partial: 'blogs/products' %>
          <% end %>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" onclick="add_products();">Save</button>
        <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
      </div>
    </div>

  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.1.1/min/dropzone.min.js"></script>
<script>
  $(":file").filestyle({input: false});

    // $('textarea.editor').ckeditor();

    var menu = new BootstrapMenu('#demo1Box', {
        actions: [{
            name: 'Upload image',
            onClick: function() {
//                toastr.info("'Upload image");
                $('#uploadVideo').modal('show')
            }
        },

            {
                name: 'Add video from youtube',
                onClick: function() {
                    $('#uploadVideo').modal('show')
                }
            }]
    });

    $(window).bind('load', function(){
      $('#blog-form').submit(validateDescriptionLength)
      var v = CKEDITOR.instances.blog_description
      words = CKEDITOR.instances.blog_description.getData().match(/\S+/g)
      if (words) { $('#display_count').text(`Total Words: ${words.length}`); }
      v.on('key', function(event) {
        words = CKEDITOR.instances.blog_description.getData().match(/\S+/g)
        if (words) {
          $('#display_count').text(`Total Words: ${words.length}`);
        }
      });

      function validateDescriptionLength(){
        var description = CKEDITOR.instances.blog_description.getData().match(/\S+/g);
        if ($('#blog_category_id').val() == '' ) { alert("Select Category"); return false; }
        if ($('#blog_title').val() == '' ) { alert("Add title"); return false; }
        if (description) {
          if (description.length < 150) {
            alert("Description must be atleast 150 words long.")
            return false
          } else { return true }
        }
        else {
          alert("Please add Blog description");
          return false;
        }

      }
    });

    $("#fileupload").change(function () {

        readURL(this);
    });
    function readURL(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        var name = input.files[0].name
        var fileType = input.files[0].type
        var ValidImageTypes = ["image/gif", "image/jpeg", "image/png"];

        if ($.inArray(fileType, ValidImageTypes) < 0) {
          return alert("File type not allowed.")
        }

        reader.onload = function (e) {
          var st = e.target.result;
          $('#blah').attr('src', e.target.result);
          $('#fileUpload').attr('src', e.target.result);
        };
        $('#file-name').text(name);
        reader.readAsDataURL(input.files[0]);
      }
    }
    function get_products(){
        $('#assignProduct').modal('show');
        $.ajax({
            url: '/get_products_from_shopify?id=<%= @blog.present? ? @blog.id : '' %>',
            type: 'get',
            dataType: 'html',
            processData: false,
            success: function (data) {
                $('#products').html(data);
            },
            error: function (data) {
                alert('Error');
                //    window.location.reload();
            }
        });
    }
    function add_products(){
        var ids = [];
        $(".selected").each(function(index, v) {
            console.log($(v).attr('class').split(' ')[0]);
            ids.push($(v).attr('class').split(' ')[0]);
        });
        if (ids != ""){
            $.ajax({
                url: '/get_selected_products?ids='+ids,
                type: 'get',
                dataType: 'html',
                processData: false,
                success: function (data) {
                    $('#selectedProducts').html(data);
                    $('#assignProduct').modal('hide');
                },
                error: function (data) {
                    alert('Error');
                    //    window.location.reload();
                }
            });
        }
    }





$.fn.extend({
    popoverClosable: function (options) {
        var defaults = {
            template:
                '<div class="popover">\
<div class="arrow"></div>\
<div class="popover-header">\
<button type="button" class="close" data-dismiss="popover" aria-hidden="true">&times;</button>\
<h3 class="popover-title"></h3>\
</div>\
<div class="popover-content"></div>\
</div>'
        };
        options = $.extend({}, defaults, options);
        var $popover_togglers = this;
        $popover_togglers.popover(options);
        $popover_togglers.on('click', function (e) {
            e.preventDefault();
            $popover_togglers.not(this).popover('hide');
        });
        $('html').on('click', '[data-dismiss="popover"]', function (e) {
            $popover_togglers.popover('hide');
        });
    }
});

$(function () {
    $('[data-toggle="popover"]').popoverClosable();
});





</script>